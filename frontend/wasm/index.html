<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InfiniEmu</title>
    <script src="https://cdn.jsdelivr.net/npm/@zip.js/zip.js@2.7.45/dist/zip.min.js"></script>
    <style>
        #sleepCover {
            position: absolute;
            top: 0;
            left: 0;
            width: 240px;
            height: 240px;
            background-color: black;
            display: none;
            pointer-events: none;
        }
    </style>
</head>

<body>
    <div id="pickerForm">
        <input id="programPicker" type="file" onchange="loadProgramFile(this.files[0])">
        <br>
        <button onclick="loadSampleFile()">Load sample file</button>
        <br>
        <br>
    </div>

    <div style="position: relative">
        <canvas id="display" width="240" height="240" style="background-color: red;"></canvas>
        <div id="sleepCover"></div>
    </div>

    <div id="performance"></div>

    <div>
        <input type="text" id="command">
        <button onclick="myWorker.postMessage({ type: 'runCommand', command: document.getElementById('command').value })">Run</button>
    </div>

    <script>
        const myWorker = new Worker("infiniemu.worker.js");
        const display = document.getElementById("display");
        const sleepCover = document.getElementById("sleepCover");

        async function loadDFU(data) {
            const zr = new zip.ZipReader(new zip.Uint8ArrayReader(data));

            let entries;
            try {
                entries = await zr.getEntries();
            } catch (e) {
                console.log("Failed to read input as ZIP file", e);
                return false;
            }

            const binEntry = entries.find(e => e.filename.endsWith(".bin"));
            if (!binEntry) {
                alert(`Bin file "${binFileName}" not found in the ZIP file`);
                return;
            }

            if (binEntry.filename.includes("mcuboot")) {
                alert("MCUBoot DFU files are not supported, this probably won't work");
            }

            return await binEntry.getData(new zip.Uint8ArrayWriter());
        }

        function loadProgramFile(file) {
            const reader = new FileReader();
            reader.onload = async e => {
                const arr = new Uint8Array(e.target.result);

                const binFile = await loadDFU(arr);
                if (binFile) {
                    myWorker.postMessage({ type: "loadProgram", program: binFile });
                } else {
                    myWorker.postMessage({ type: "loadProgram", program: arr });
                }
                document.getElementById("pickerForm").remove();
            };
            reader.readAsArrayBuffer(file);
        }

        function loadSampleFile() {
            const sampleUrl = "https://share.pipe01.net/-XpJvumKzSS/pinetime-app-1.14.0.bin";

            fetch(sampleUrl)
                .then(resp => resp.arrayBuffer())
                .then(data => {
                    myWorker.postMessage({ type: "loadProgram", program: new Uint8Array(data) });
                    document.getElementById("pickerForm").remove();
                });
        }

        let isMouseDown = false, isButtonDown = false;
        let hasSwiped = false;
        let mouseDownX, mouseDownY;

        display.addEventListener("contextmenu", e => {
            e.preventDefault();
        });

        display.addEventListener("mousedown", e => {
            e.preventDefault();

            if (e.button == 0) {
                isMouseDown = true;

                mouseDownX = e.offsetX;
                mouseDownY = e.offsetY;
            } else if (e.button == 2) {
                isButtonDown = true;

                myWorker.postMessage({ type: "pressButton" });
            }
        });
        display.addEventListener("mousemove", e => {
            if (!isMouseDown) {
                return;
            }

            e.preventDefault();

            const distX = e.offsetX - mouseDownX;
            const distY = e.offsetY - mouseDownY;
            const dist = Math.sqrt(distX * distX + distY * distY);

            if (dist > 50 && !hasSwiped) {
                hasSwiped = true;

                let gesture;

                if (Math.abs(distX) > Math.abs(distY)) {
                    gesture = distX > 0 ? 0x04 : 0x03;
                } else {
                    gesture = distY > 0 ? 0x01 : 0x02;
                }

                myWorker.postMessage({ type: "doTouch", gesture, x: e.offsetX, y: e.offsetY });
            }
        });
        display.addEventListener("mouseup", e => {
            e.preventDefault();

            if (isButtonDown) {
                isButtonDown = false;

                myWorker.postMessage({ type: "releaseButton" });
            }

            if (isMouseDown) {
                isMouseDown = false;

                if (hasSwiped) {
                    hasSwiped = false;
                    myWorker.postMessage({ type: "clearTouch" });
                } else {
                    myWorker.postMessage({ type: "doTouch", gesture: 0x05, x: e.offsetX, y: e.offsetY, duration: 200 });
                }
            }
        });

        const ipsData = [];

        setInterval(() => {
            const avg = ipsData.reduce((acc, val) => acc + val, 0) / ipsData.length;

            document.getElementById("performance").innerText = avg.toFixed(0) + " instructions per second";
        }, 500);

        const offscreen = display.transferControlToOffscreen();

        myWorker.postMessage({ type: "init", canvas: offscreen }, [offscreen]);

        myWorker.onmessage = function (e) {
            const { type, data } = e.data;

            switch (type) {
                case "performance":
                    ipsData.push(data.ips);
                    if (ipsData.length > 20) {
                        ipsData.shift();
                    }
                    break;

                case "lcdSleeping":
                    sleepCover.style.display = data ? "block" : "none";
                    break;

                case "error":
                    alert("Emulation failed: " + data);
                    break;
            }
        };
    </script>
</body>

</html>