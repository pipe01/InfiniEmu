<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        #sleepCover {
            position: absolute;
            top: 0;
            left: 0;
            width: 240px;
            height: 240px;
            background-color: black;
            display: none;
            pointer-events: none;
        }
    </style>
</head>

<body>
    <div id="pickerForm">
        <input id="programPicker" type="file" onchange="loadProgramFile(this.files[0])">
        <h3>
            Try using
            <a href="https://share.pipe01.net/-XpJvumKzSS/pinetime-app-1.14.0.bin">this</a> InfiniTime build
        </h3>
    </div>

    <div style="position: relative">
        <canvas id="display" width="240" height="240" style="background-color: red;"></canvas>
        <div id="sleepCover"></div>
    </div>

    <div id="performance"></div>

    <script>
        const myWorker = new Worker("infiniemu.worker.js");
        const display = document.getElementById("display");
        const sleepCover = document.getElementById("sleepCover");

        function loadProgramFile(file) {
            myWorker.postMessage({ type: "loadProgramFile", file });
            document.getElementById("pickerForm").remove();
        }

        let isMouseDown = false, isButtonDown = false;
        let hasSwiped = false;
        let mouseDownX, mouseDownY;

        display.addEventListener("contextmenu", e => {
            e.preventDefault();
        });

        display.addEventListener("mousedown", e => {
            e.preventDefault();

            if (e.button == 0) {
                isMouseDown = true;

                mouseDownX = e.offsetX;
                mouseDownY = e.offsetY;
            } else if (e.button == 2) {
                isButtonDown = true;

                myWorker.postMessage({ type: "pressButton" });
            }
        });
        display.addEventListener("mousemove", e => {
            if (!isMouseDown) {
                return;
            }

            e.preventDefault();

            const distX = e.offsetX - mouseDownX;
            const distY = e.offsetY - mouseDownY;
            const dist = Math.sqrt(distX * distX + distY * distY);

            if (dist > 50 && !hasSwiped) {
                hasSwiped = true;

                let gesture;

                if (Math.abs(distX) > Math.abs(distY)) {
                    gesture = distX > 0 ? 0x04 : 0x03;
                } else {
                    gesture = distY > 0 ? 0x01 : 0x02;
                }

                myWorker.postMessage({ type: "doTouch", gesture, x: e.offsetX, y: e.offsetY });
            }
        });
        display.addEventListener("mouseup", e => {
            e.preventDefault();

            if (isButtonDown) {
                isButtonDown = false;

                myWorker.postMessage({ type: "releaseButton" });
            }

            if (isMouseDown) {
                isMouseDown = false;

                if (hasSwiped) {
                    hasSwiped = false;
                    myWorker.postMessage({ type: "clearTouch" });
                } else {
                    myWorker.postMessage({ type: "doTouch", gesture: 0x05, x: e.offsetX, y: e.offsetY, duration: 200 });
                }
            }
        });

        const ipsData = [];

        setInterval(() => {
            const avg = ipsData.reduce((acc, val) => acc + val, 0) / ipsData.length;

            document.getElementById("performance").innerText = avg.toFixed(0) + " instructions per second";
        }, 500);

        const offscreen = display.transferControlToOffscreen();

        myWorker.postMessage({ type: "init", canvas: offscreen }, [offscreen]);

        myWorker.onmessage = function (e) {
            const { type, data } = e.data;

            switch (type) {
                case "performance":
                    ipsData.push(data.ips);
                    if (ipsData.length > 20) {
                        ipsData.shift();
                    }
                    break;

                case "lcdSleeping":
                    sleepCover.style.display = data ? "block" : "none";
                    break;
            }
        };
    </script>
</body>

</html>